"""
Example: Creating and Using Custom Plugins

This example shows how to create custom models, trainers, and use them.
"""

from core.config import ConfigNode
from core.registry import register_model, get_model, list_models
from models.base import BaseModel
import torch
import torch.nn as nn


# Example 1: Simple Custom Model
@register_model("example-simple-gan")
class SimpleGAN(BaseModel):
    """A simple GAN for demonstration"""
    
    def __init__(self, config):
        super().__init__(config)
        
        latent_dim = config.model.latent_dim
        output_dim = config.model.get('output_dim', 784)
        
        self.generator = nn.Sequential(
            nn.Linear(latent_dim, 256),
            nn.ReLU(),
            nn.Linear(256, 512),
            nn.ReLU(),
            nn.Linear(512, output_dim),
            nn.Tanh()
        )
    
    def forward(self, z):
        """Generate images from noise"""
        return self.generator(z)


# Example 2: Model with Metadata
@register_model(
    "example-advanced-gan",
    version="1.0.0",
    author="Frameworm Team",
    description="Advanced GAN with normalization"
)
class AdvancedGAN(BaseModel):
    """Advanced GAN with batch normalization"""
    
    def __init__(self, config):
        super().__init__(config)
        
        self.generator = nn.Sequential(
            nn.Linear(config.model.latent_dim, 256),
            nn.BatchNorm1d(256),
            nn.ReLU(),
            nn.Linear(256, 512),
            nn.BatchNorm1d(512),
            nn.ReLU(),
            nn.Linear(512, 784),
            nn.Tanh()
        )
    
    def forward(self, z):
        return self.generator(z)


def main():
    print("Custom Plugin Example")
    print("=" * 60)
    
    # List all models (includes our custom ones)
    models = list_models()
    print(f"\nAvailable models: {models}")
    
    # Get our custom model
    model_class = get_model("example-simple-gan")
    print(f"\nGot model class: {model_class}")
    
    # Create a simple config
    config = ConfigNode({
        'model': {
            'latent_dim': 100,
            'output_dim': 784
        }
    })
    
    model = model_class(config)
    
    # Test it
    z = torch.randn(4, config.model.latent_dim)
    output = model(z)
    print(f"\nModel output shape: {output.shape}")
    
    # Show model info
    num_params = sum(p.numel() for p in model.parameters())
    print(f"Model has {num_params:,} parameters")
    
    print("\n" + "=" * 60)
    print("âœ“ Custom plugin working!")


if __name__ == '__main__':
    main()